<html>

<% include ../partials/head %>

<body>
  <% include ../partials/nav %>
  
  <div class="container mt-5">
    <h2>Upload Employee Excel</h2>
    <form method="POST" action="/employee/new/upload" class="dropzone" id="uploadExcel" enctype="multipart/form-data">
      <div class="fallback">
        <input name="file" type="file" multiple />
      </div>
    </form>

    <div class="alert alert-danger" role="alert" style="display:none;"></div>
  </div>

  <% include ../partials/script %>
  <script>
    $(document).ready(function () {
      console.log('document ready')
      $('.mdb-select').material_select()
      $('.button-collapse').sideNav()
    })

    //Dropzone
    Dropzone.options.uploadExcel = {
      url: '/employee/new/upload',
      paramName: 'file',
      dictDefaultMessage: 'Drag an excel file to upload, or click to select one',
      acceptedFiles: '.xlsx',
      maxFilesize: 2, // MB
      accept: function (file, done) {
        done()
      },
      success: function (file, response) {
        console.log('success', response)
        $('.alert-danger').empty().hide()
        if (response.success) {
          toastr.success('Uploaded!')
        } else {
          toastr.success(`Failed to upload ${response.failCounter} rows`)
        }
      },
      error: function(file, error) {
        console.log('error', error)
        if (error.invalidInfo) {
          toastr.error('Invalid Excel File')
          $('.alert-danger').empty().show()
          if (error.invalidInfo.mandatoryColumns.length) {
            let $mandatoryList = $('<ul>').appendTo($('.alert-danger').append('<h3>Blank Mandatory Column(s)</h3>'))
            for (let col of error.invalidInfo.mandatoryColumns) {
              $mandatoryList.append($('<li>').text(col))
            }
          } 
          if (error.invalidInfo.mismatchTypeCell.length) {
            let $mismatchList = $('<ul>').appendTo($('.alert-danger').append('<h3>Mismatch Data Type Cell(s)</h3>'))
            for (let cell of error.invalidInfo.mismatchTypeCell) {
              $mismatchList.append($('<li>').text(cell))
            }
          }
        } else {
          toastr.error('Error!')
        }
      }
    }
  </script>
</body>

</html>