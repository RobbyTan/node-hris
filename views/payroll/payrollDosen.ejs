<% include ../partials/attendanceHeader%>
<div class="container">
  <h3>View Dosen Tidak Tetap Payroll</h3>
  <div id="validation-alert" class="alert alert-danger" style="display: none; text-align: center;" role="alert"></div>
  <table class="table">
    <label class="pl-3">From:</label>
    <div class="md-form col-xl-3">
      <input name="from" type="date" id="from_txt" required>
    </div>
    <label class="pl-3">To:</label>
    <div class="md-form col-xl-3">
      <input name="to" type="date" id="to_txt" required>
    </div>
    <button id="generate_button" type="button" class="btn btn-primary">Generate</button>
    <br>
    <div class="preloader-wrapper big active" id="spinner" style="display: none;top: 50%; left: 50%;">
      <div class="spinner-layer spinner-blue-only">
        <div class="circle-clipper left">
          <div class="circle"></div>
        </div>
        <div class="gap-patch">
          <div class="circle"></div>
        </div>
        <div class="circle-clipper right">
          <div class="circle"></div>
        </div>
      </div>
    </div>

    <table id="data_table" class="table stripe" cellspacing="0" width="100%">
      <thead>
        <tr>
          <td>Kategori Kepegawaian</td>
          <td>Nomor Induk Karyawan (NIK)</td>
          <td>Nama Depan</td>
          <td>Nama Tengah</td>
          <td>Nama Belakang/Marga</td>
          <td>Departemen/Fakultas</td>
          <td>Spesialisasi</td>
          <td>Cost Center</td>
          <td>Nama Mata Kuliah</td>
          <td>Jumlah Sesi Tutorial</td>
          <td>Jumlah Sesi Lecture</td>
          <td>Total Sesi</td>
          <td>Perhitungan Gaji</td>
          <td>Jenis Mata Uang</td>
          <td>Jumlah Gaji Saat Ini</td>
          <td>Penerimaan Gaji</td>
          <td>Total Durasi Jam Kerja</td>
          <td>Gaji Pokok/Total Gaji per Jam</td>
          <td>Penambahan/Pengurangan</td>
          <td>Keterangan Penambahan/Pengurangan</td>
          <td>Total Gaji Yang Diterima</td>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </table>
</div>

</div>
</main>
<br>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>
<script src="/scripts/mdb.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.8/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/dataTables.buttons.min.js">
</script>
<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js">
</script>
<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/pdfmake.min.js">
</script>
<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.32/vfs_fonts.js">
</script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.html5.min.js">
</script>
<script src="/scripts/attendances/date-input-validator.js"></script>
<script src="/scripts/attendances/loading-spinner.js"></script>
<script src="/scripts/attendances/clock-pairing.js"></script>
<script src="/scripts/payroll/payroll-calculator.js"></script>

<script type="text/javascript">
  $(".button-collapse").sideNav();
  $('.mdb-select').material_select();
  $('#data_table').DataTable({
    dom: 'Bfrtip',
    lengthMenu: [
      [10, 25, 50, -1],
      [10, 25, 50, "All"]
    ],
    buttons: [
      'pageLength',
      'copyHtml5',
      'excelHtml5',
      {
        extend: 'pdf',
        text: 'Pdf',
        orientation: 'landscape'
      }
    ]
  });

  //initialize form
  let monthTo = (moment().month()+1)<10 ? "0"+(moment().month()+1) : (moment().month()+1);
  let monthFrom = moment().month()<10?"0"+moment().month():moment().month();
  let dateTo = moment().year()+"-"+monthTo+"-15";
  let dateFrom = moment().year()+"-"+monthFrom+"-16";
  $('#from_txt').val(dateFrom);
  $('#to_txt').val(dateTo);

  let dosenTidakTetapMaxTime = '<%=configuration.dosenTidakTetapMaxTime%>';
  let dateInputValidator = DateInputValidator.bind({
    fromTxt: 'from_txt',
    toTxt: 'to_txt'
  });
  let loadingSpinner = LoadingSpinner.bind({
    spinner: 'spinner',
    hideableNodes: ['data_table_wrapper'],
    disableNodes: ['generate_button']
  });

  function renderTable(rows) {
    $.fn.dataTable.ext.errMode = 'none';
    let result = [];
    for (let row of rows) {
      result.push([
        row.kategori_pegawai,
        
        //nama lengkap sesuai KTP
        row.nama_depan,
        row.nama_tengah,
        row.nama_belakang,

        //posisi kerja
        row.department,
        row.spesialisasi,
        row.cost_center,

        //data payroll
        row.perhitungan_gaji,
        row.jenis_mata_uang,
        row.jumlah_gaji_saat_ini,
        row.penerimaan_gaji,

        //data perhitungan gaji dan ayroll
        row.total_durasi_kerja,
        row.gaji_pokok,
        '-',
        '-',
        row.total_gaji
      ]);
    }
    $('#data_table').DataTable({
      dom: 'Bfrtip',
      "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
      buttons: [
        'pageLength',
        'copyHtml5',
        'excelHtml5',
        {
          extend: 'pdf',
          text: 'Pdf',
          orientation: 'landscape'
        }
      ],
      data: result,
      columns: [
        {title: 'Kategori Pegawai'},  
        {title: 'NIK'},

        // nama lengkap sesuai KTP
        {title: 'Nama depan'},
        {title: 'Nama tengah'},
        {title: 'Nama belakang'},

        // posisi kerja
        {title: 'Departemen'},
        {title: 'Spesialisasi'},
        {title: 'Cost Center'},
        
        // data payroll
        {title: 'Perhitungan gaji'},
        {title: 'Jenis mata uang'},
        {title: 'Jumlah gaji saat ini'},
        {title: 'Penerimaan gaji'},
        
        // Perhitungan Jam Kerja dan Payroll
        {title: 'Total durasi kerja'},
        {title: 'Gaji pokok/Total gaji per jam'},
        {title: 'Penambahan/Pengurangan'},
        {title: 'Keterangan Penambahan/Pengurangan'},
        {title: 'Total gaji yang diterima'}
      ]
    });
  }

  $('#generate_button').on('click', () => {
    if (!dateInputValidator.isValid()) return;
    let fromString = $('#from_txt').val();
    let toString = $('#to_txt').val();
    loadingSpinner.start();
    $.getJSON("/api/attendances", {
        from: fromString,
        to: toString
      }).then(attendances => {
        let payrollResult = PayrollCalculator.process(attendances, {
          dosenTidakTetapMaxTime: dosenTidakTetapMaxTime
        });
        renderTable(payrollResult);
        loadingSpinner.stop();
      }).catch(err => {
        loadingSpinner.init();
      });
  });
</script>
</body>

</html>